@page
@using FirestormSW.SmartGrade.Database
@using FirestormSW.SmartGrade.Database.Model
@using Microsoft.EntityFrameworkCore
@model FirestormSW.SmartGrade.Pages.Admin.Registry
@inject AppDatabase Database;

@{
    Layout = "Shared/Admin/AdminLayout";
}

<!--begin::Entry-->
<div class="d-flex flex-column-fluid">
    <!--begin::Container-->
    <div class="container">
        <!--begin::Card-->
        <div class="card card-custom">
            <div class="card-header py-3">
                <div class="card-title">
                    <span class="card-icon">
                        <span class="svg-icon svg-icon-md svg-icon-primary">
                            <img data-svg="true" alt="" src="~/assets/admin/media/svg/icons/Design/Select.svg"/>
                        </span>
                    </span>
                    <h3 class="card-label">Registry</h3>
                </div>
            </div>
            <div class="card-body">
                <!--begin::Search Form-->
                <div class="mt-2 mb-7">
                    <div class="row align-items-center">
                        <div class="w-100">
                            <div class="row align-items-center">
                                <div class="col-md-2 my-2 my-md-0">
                                    <div class="d-flex align-items-center">
                                        <label class="mr-3 mb-0 d-none d-md-block">User:</label>
                                        <select class="form-control" id="search_user">
                                            <option label="Label"></option>
                                            @foreach (var user in Database.Users
                                                .Include(u => u.Groups)
                                                .OrderBy(u => u.FullName)
                                                .Where(u => u.Groups.Any(g => g.GroupType == GroupType.Teacher)))
                                            {
                                                <option value="@user.Id">@user.FullName</option>
                                            }
                                        </select>
                                        <script>
                                        $('#search_user').select2({
                                            placeholder: "Select a user"
                                        });
                                        </script>
                                    </div>
                                </div>
                                <div class="col-md-2 my-2 my-md-0">
                                    <div class="d-flex align-items-center">
                                        <label class="mr-3 mb-0 d-none d-md-block">Date:</label>
                                        <input type="text" class="form-control" id="search_date" readonly placeholder="Select date"/>
                                        <script>
                                        $('#search_date').datepicker({
                                            maxViewMode : 'months',
                                            minViewMode : 'months',
                                            orientation: 'bottom left',
                                            format: 'yyyy. M'
                                        }).datepicker("setDate", 'now');
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end::Search Form-->
                <!--end: Search Form-->
                <!--begin: Datatable-->
                <div class="datatable datatable-bordered datatable-head-custom" id="kt_datatable"></div>
                <!--end: Datatable-->
            </div>
            <div class="card-header py-3">
                <div class="card-title">
                    <span class="card-icon">
                        <span class="svg-icon svg-icon-md svg-icon-primary">
                            <img data-svg="true" alt="" src="~/assets/admin/media/svg/icons/Code/Warning-2.svg"/>
                        </span>
                    </span>
                    <h3 class="card-label">Not locked yet</h3>
                </div>
            </div>
            <div class="card-body">
                <!--begin::Search Form-->
                <div class="mt-2 mb-7">
                    <div class="row align-items-center">
                        <div class="w-100">
                            <div class="row align-items-center">
                                <div class="col-md-2 my-2 my-md-0">
                                    <div class="d-flex align-items-center">
                                        <label class="mr-3 mb-0 d-none d-md-block">Date:</label>
                                        <input type="text" class="form-control" id="search_date_range" readonly placeholder="Select time"/>
                                        <script>
                                            $('#search_date_range').daterangepicker({
                                                autoApply: true
                                            }).daterangepicker("setDate", 'now');
                                        </script>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!--end::Search Form-->
                <ul class="columns" id="not_locked_users">
                </ul>
            </div>
        </div>
        <!--end::Card-->
    </div>
    <!--end::Container-->
</div>
<!--end::Entry-->

<iframe id="print-frame" src="" style="visibility: hidden"></iframe>

<script>

let datatableDataColumns = [
    {
        field: 'WeekString',
        title: 'Week'
    }, {
        field: 'Locked',
        title: 'Locked',
        template: function (row) {
            if (row.Locked === true) 
                return '<span class="label label-success label-pill label-inline mr-2">yes<span>';
            else 
                return '<span class="label label-danger label-pill label-inline mr-2">no</span>';
        }
    }, {
        field: 'Count',
        title: 'Hours'
    }, {
        field: 'Print',
        title: 'Print',
        width: 125,
        template: function (row) {
            return `\
                <a href="javascript:;" onclick="printWeek('${row.WeekDate}', ${row.UserId})" class="btn btn-sm btn-clean btn-icon mr-2" title="Print">\
                    <span class="svg-icon svg-icon-md">\
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" version="1.1">\
                            <g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">\
                                <rect x="0" y="0" width="24" height="24"/>\
                                <path d="M16,17 L16,21 C16,21.5522847 15.5522847,22 15,22 L9,22 C8.44771525,22 8,21.5522847 8,21 L8,17 L5,17 C3.8954305,17 3,16.1045695 3,15 L3,8 C3,6.8954305 3.8954305,6 5,6 L19,6 C20.1045695,6 21,6.8954305 21,8 L21,15 C21,16.1045695 20.1045695,17 19,17 L16,17 Z M17.5,11 C18.3284271,11 19,10.3284271 19,9.5 C19,8.67157288 18.3284271,8 17.5,8 C16.6715729,8 16,8.67157288 16,9.5 C16,10.3284271 16.6715729,11 17.5,11 Z M10,14 L10,20 L14,20 L14,14 L10,14 Z" fill="#000000"/>\
                                <rect fill="#000000" opacity="0.3" x="8" y="2" width="8" height="2" rx="1"/>\
                            </g>\
                        </svg>\
                    </span>\
                </a>\
            `;
        }
    }
];

let API_PATH = "/api/admin/registry/";
let datatable = $('#kt_datatable').KTDatatable({
    data: {
        type: 'remote',
        source: {
            read: {
                url: HOST_URL + API_PATH + 'list',
                method: 'GET'
            },
        },
        pageSize: 10,
        saveState: false,
        serverPaging: true,
        serverFiltering: true,
        serverSorting: true,
    },

    layout: {
        scroll: false
    },

    sortable: false,
    pagination: false,

    // columns definition
    columns: datatableDataColumns

});

function printWeek(week, userId) {
    let frame = window.frames['print-frame'];
    frame.src = `/Admin/RegistryExport?userId=${userId}&weekDate=${week}`;
}

function printWindowLoaded() {
    let frame = window.frames['print-frame'];
    frame.contentWindow.print();
}

let searchUser = $('#search_user');
let searchDate = $('#search_date');
let searchDateRange = $('#search_date_range');

searchUser.on('change', updateDatatable);
searchDate.on('change', updateDatatable);
searchDateRange.on('change', updateNoLockedUsers);

function updateDatatable() {
    datatable.setDataSourceParam('UserId', searchUser.val());
    datatable.setDataSourceParam('MonthDate', searchDate.val());
    datatable.reload();
}

function updateNoLockedUsers() {
    $.ajax({
        url: HOST_URL + API_PATH + 'list_not_locked',
        method: 'GET',
        data: {
            range: $(this).val()
        },
        success: function (result) {
            let list = $('#not_locked_users');
            list.empty();
            result.forEach(e => {
                list.append($(`<li>${e.FullName}</li>`));
            });
        }
    });
}

updateDatatable();
updateNoLockedUsers();

</script>